我们很快会去造挂钩，还有刀叉啥的玩意儿，但我想到如果现在试图把它们挂一起，就会出现一个大问题――

它们会穿模。

# 05 - 挂不上去

我需要碰撞！我们没有碰撞系统！！虽然我一开始就应该考虑好这个...但无所谓，现在做也行。

厨房里的墙、柜子、桌子，目前都只是“画”出来的贴图。天哪，AIk 小时候做饭把菜放在菜板子上，然后菜板子和菜一起掉地上了。好在没有摔个稀巴烂，但是掉虚空是个什么意思？？

所以说碰撞系统是很有必要的。这时候就有同学问了，主播主播，那我们把 `avian` 或者 `rapier` 引过来吧——你疯辣？咱做的是割绳子或者愤怒的小鸟吗？把整个物理系统引过来？？

要注意的是我说的是“碰撞系统”... 而不是物理系统。说实在的，我们没有必要给 dr / ut 这类游戏上一套完整的 2d 物理系统，这可有点浪费了...杀鸡焉用牛刀？咱大多数功能用不到啊（就算是蓝魂那个跳跃，我记得大概也不是基于物理系统实现的）。我们不需要搞什么别样的碰碰车大战，所以搞一个性能好，无关物理，实现容易的碰撞系统就得了。咱用的是 bevy，选择权是我们的优势。

这样的方案存在吗？存在的――有向距离场，SDF（Signed Distance Fields），完美契合。

...这会是你第一次看到它。但绝不是最后一次。

## 万物皆可 SDF

SDF 这东西，简单来说，就是一张“地图”，它不记录颜色，而是记录空间中每一个点到最近物体边界的“距离”。如果在物体外面，距离是正的；如果在物体里面，距离是负的。当一个东西想移动时，我们只要查一下它要去的地方的“距离”是不是负的，就知道它会不会“撞墙”了。

这套方案简直是为我们这种像素游戏量身定做的。它计算开销小，而且效果出奇地好，特别是处理角色沿着墙壁“滑行”而不是被卡住的场景。并且，SDF 还可以用于 GPU 绘图……我们很快会讲到 UI。那些方框子用 SDF 不香吗？想想未来的战斗系统，你们喜欢的七扭八歪的战斗框，各种多边形甚至曲线形，那不都是 SDF 擅长的领域么？总比三角刨分库强吧？

*笑点解析：UCT 用的是三角刨分库。*

于是，新的模块 `core/collision` 就诞生了。这是我们厨房里专门用来处理 “碰撞体” 的部门。

第一步，就是回去返工我们的地砖（第四章的内容）。我得告诉游戏，`ruins_3.tmx` 这个地图里，哪些瓦片是墙，是柱子，是不能走的地方。我给名为 `collision` 的瓦片层都视为瓦片，同时还给对象层需要碰撞的瓦片贴上了 “collision” 的 Bool 标签，SDF 系统会自动把它们融合成一个无缝的、完整的碰撞区域。这样，无论墙角多么崎岖，角色都能顺滑地贴着走。

```rust
// crates/souprune/src/core/collision/systems.rs

// 实现了 SDF 合并以实现无缝瓦片地图碰撞
// 实现了基于梯度的 SDF 碰撞系统
// 实现了迭代式 SDF 碰撞解决
// ...
```

然后是玩家自己。我也得给 Frisk 一个“形状”，一个碰撞箱。不大不小，正好能体现出“人类”的实体感。当这个“形状”将要和墙壁的“距离场”发生重叠时，系统就会介入，优雅地推开玩家，而不是让人家一头撞上去。

```rust
// crates/souprune/src/app_state/overworld/player/systems.rs

// 实现了玩家与瓦片地图的碰撞检测，并进行了移动细化
```

最妙的是“迭代式解决”这个想法。它不是一次性地阻止你，而是像水流一样，一步步引导你到可以移动的位置。结果就是，当你斜着撞向一堵墙时，你会感觉角色非常自然地沿着墙边滑了过去，而不是像个傻子一样卡在原地。

*这一步可折腾死我了，因为我最开始的写法会让角色一直卡角……哎呦。*

## 顺带给相机上个锁

在折腾碰撞的时候，我发现了一个新问题：角色在地图边缘走的时候，相机会跟着跑到地图外面去，露出一片灰色，太出戏了。

既然厨房的墙已经砌好了，那也该给摄影师（相机）画个活动范围了。于是我顺手给相机系统加了个边界限制，让它老老实实地待在地图内部，别再到处乱跑。

现在，一切都“坚固”起来了。角色有了实体，墙壁有了厚度，厨房终于不再是个虚无缥缈的幻象。那些刀叉筷勺，现在可以稳稳地“挂”在墙上，再也不会穿模了。

厨房的装修，总算又向“实体化”迈进了一大步。

下一步就是 UI 了。乘胜追击吧。在 SDF 的基础上，下一步应该不难…… 就是麻烦。

---

企划时间：2025-10-31

开始时间：2025-11-15

完成时间：2025-11-16

关联的 PR：[#13](https://github.com/Bli-AIk/souprune/pull/13)
