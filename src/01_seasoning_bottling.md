回想起当年刚学 Unity 的时候，我抱着还没消化完的 C# 基础[^1]，看了那个至今我难以忘记的 **Ruby' Adventure[^2]** 教程。从那时起，我想我可能就明白了一些事情，一些影响我至深的事情，一些我至今也无法改变的事情――

比方说，做一个游戏的第一步是把角色状态机搓出来。

# 01 - 调料装瓶

嘛，所以说角色是调料。我没想太多需要打什么比方，反正就是说角色是调料了。路边俩npc可能是什么孜然粉胡椒粉啥的，主要角色那就油盐酱醋葱姜蒜？而主人公是什么呢...反正就搁里面随便找一个好了。

调料是做饭必不可少的一环。虽然我们是要装修厨房，但最后咋的也是要做饭的。上来就修地板砌墙也不是很有意思，对吧？再加上以前我都是先做调料，那调料大概味道也不错！熟悉，并且很有味道...往往是刺激性的。别弄大劲儿了就行。

所以我们的第一步就是搓角色状态机，让主角能站立、走起来、跑起来――这就是“状态”。很好，今儿的目标有了。

## 瓶子是现成的（？，调料是现成的

感谢 undertale 闭源――但是可以满大街找到的 toby 也懒得管的拆包，那也算是开源了。所以说，素材什么的都是现成的。之前做 UCT 存的素材还都能用呢，那可太好啦――我们不就有现成的调料了么？

流体要看容器来塑形，对于调料这种稀碎的东西来说也是这样吧...你们家里都拿什么瓶子或者小碗装调料哦？我家好像都是拿原包装，或者就是装小碗。但我们的厨房里面没有装好调料的瓶子――但现成的瓶子是有的――或者说现成的瓶子是可以现拼的。那还算是现成的吗？

上一次装调料是咋装的呢――哦不，我在 UCT 的时候，最开始的代码压根没有把调料装瓶里，用的时候都是抓一把就用了，太不讲究了。

但后来也做了些重构吧。我把很多状态写了出来――静止，走动，跑动...没有问题...然后，“坠落”？

我记得我是写了个“坠落”状态。虽然本质上来说，“坠落”就是在静止的基础上加了个动画。但很可惜，我压根没把动画和状态本身分离。想象一下之后如果要做什么剧情过场，有很多个动画，一会儿打伞一会儿被电的，那如果状态和动画一样多，那可就太哈人了。“静止”状态下仍然应该可以放任何动画，其他状态的也一样――动画和状态必须分离！但特么我当初就没这么干。谁知道我当初是咋想的呢？反正，这都是我们之后要规避的问题。

总而言之，大概做状态机不算难事，状态机就是...状态，没什么好说的。倒也有一个难点――我这还是第一次正儿八经用 bevy――但不是第一次正儿八经学rust、看ECS，也不是正儿八经第一次用游戏引擎，做游戏开发！唯一“第一次”的就是拿 rust 在 bevy 用 ECS 开发 游戏... 多看看示例就好啦！大概吧。


## 先把调料本身准备好！

以往我都是在 OOP 下写状态机。思考了一会儿，然后我发现好像状态机在 ECS 下也有点新鲜嘛！毕竟从 OOP 转向 数据驱动，那思路还是有点区别的――但对于状态机来说，数据驱动明显更舒服一些。

但是，我们还是需要先把调料本身准备好——咱现在不是在 Unity 里面了，不是把贴图拖进去就能用啦。Bevy里面的素材管理也是门学问。

不过，我不想花太多功夫在管理素材上——我是做游戏的还是搞贴图的啊喂？所以说，现在先一切从简，我们参考 [texture_atlas](https://github.com/bevyengine/bevy/blob/main/examples/2d/texture_atlas.rs) 教程来生成图集。

首先，这个实例里面定义了default_nearest。我们是像素游戏所以——没啥好说的。

嗯，然后有一个 AppState。我喜欢叫它“大状态机”。Bevy 里面应该没有 Unity 式的（令人诟病的）场景系统。所以我们用一个更好配置的“大状态机”。这是一点毛病没有的。

```rust
#[derive(Debug, Clone, Copy, Default, PartialEq, Eq, Hash, States)]
enum AppState {
    #[default]
    Setup,
    Finished,
}
```

看没，我就说做游戏就是一会儿这个一会儿那个。我们需要做状态机——我是说，给角色的“小状态机”，但是不得不先把“大状态机”处理好。之后这样的事儿多着呢，哈哈——比方说接下来我们要处理素材。

示例里面定义个了`RpgSpriteFolder`。来保存精灵文件夹的句柄。我们做同样的事情，但是起名为`OverWorldCharacterSpriteFolder`。

```rust
#[derive(Resource, Default)]
struct OverWorldCharacterSpriteFolder(Handle<LoadedFolder>);

fn load_textures(mut commands: Commands, asset_server: Res<AssetServer>) {
    commands.insert_resource(OverWorldCharacterSpriteFolder(
        asset_server.load_folder("textures/overworld/characters"),
    ));
}
```
名字很长，但我的显示器放得下，并且一目了然—— OverWorld 下的角色 Sprite 文件夹。那就没问题。

这里，我把读取的路径设为了 `textures/overworld/characters`。

哦对了，现在的 `main` 方法长这样：
```rust
fn main() {
    App::new()
        .add_plugins(DefaultPlugins.set(ImagePlugin::default_nearest()))
        .init_state::<AppState>()
        .add_systems(OnEnter(AppState::Setup), load_textures)
        .run();
}
```

好，弄到这里就很不错了。休息一下。休息的方式就是先不敲码了，先把贴图给处理好。



## 把调料装进瓶子里...


## ...然后倒入另一个瓶子

跑步状态

## 别把瓶子整掉地上了啊喂

“坠落”动画状态


[^1]: [【C#基础 + WinForms-哔哩哔哩】](https://www.bilibili.com/video/BV1Gx411U7Hb)，虽然讲的磨叽点吧，但毕竟是引我上路的教程，还是挺好的。C#真是最好学的编程语言了。

[^2]: [【Unity2D官方入门教程 Ruby' Adventure 完整版~-哔哩哔哩】](https://www.bilibili.com/BV1V4411W787)，我个人觉得是相当权威的 Unity 入门教程，要是大伙儿都看过一遍就太好了。
